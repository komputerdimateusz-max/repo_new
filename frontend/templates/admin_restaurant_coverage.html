{% extends "base.html" %}

{% block title %}{{ t('coverage.title', lang) }} · repo_new{% endblock %}

{% block content %}
<div class="page-container">
  <header class="page-header">
    <div>
      <h1 class="page-title">{{ t('coverage.title', lang) }}</h1>
      <p class="page-subtitle">{{ t('coverage.subtitle', lang) }}</p>
    </div>
    <span class="pill pill--accent">{% if current_user.role == 'restaurant' %}{{ t('coverage.role.restaurant', lang) }}{% else %}{{ t('coverage.role.admin', lang) }}{% endif %}</span>
  </header>

  {% if current_user.role == "admin" %}
  <section class="section">
    <h2 class="section-title">{{ t('coverage.restaurant', lang) }}</h2>
    <div class="form-card">
      <form method="get" action="/admin/restaurant-coverage" class="stack-md">
        <label class="field"><span>{{ t('coverage.restaurant', lang) }}</span>
          <select class="input" name="restaurant_id" onchange="this.form.submit()">
            {% for restaurant in restaurants %}
            <option value="{{ restaurant.id }}" {% if selected_restaurant_id == restaurant.id %}selected{% endif %}>{{ restaurant.name }}</option>
            {% endfor %}
          </select>
        </label>
      </form>
    </div>
  </section>
  {% endif %}

  {% if current_user.role == "restaurant" %}
  <section class="section">
    <h2 class="section-title">{{ t('coverage.served_postal_codes', lang) }}</h2>
    <div class="form-card">
      {% if active_postal_codes %}
      <p>{{ active_postal_codes | join(', ') }}</p>
      {% else %}
      <p>{{ t('coverage.no_served_postal_codes', lang) }}</p>
      {% endif %}
      <a href="/restaurant/postal-codes" class="btn btn-secondary">{{ t('coverage.manage_postal_codes', lang) }}</a>
    </div>
  </section>

  <section class="section">
    <h2 class="section-title">{{ t('coverage.add_location', lang) }}</h2>
    <div class="form-card">
      {% if can_add_locations %}
      <form method="post" action="/restaurant/coverage" class="stack-md">
        <input type="hidden" name="action" value="add_location" />
        <label class="field"><span>{{ t('locations.company_name', lang) }}</span><input class="input" name="company_name" required /></label>
        <label class="field"><span>{{ t('locations.address', lang) }}</span><input class="input" name="address" required /></label>
        <label class="field"><span>{{ t('locations.postal_code', lang) }}</span>
          <select class="input" name="postal_code" required>
            <option value="">{{ t('coverage.select_postal_code', lang) }}</option>
            {% for code in active_postal_codes %}
            <option value="{{ code }}">{{ code }}</option>
            {% endfor %}
          </select>
        </label>
        <button type="submit" class="btn btn-primary">{{ t('coverage.add_location_submit', lang) }}</button>
      </form>
      {% else %}
      <p>{{ t('coverage.add_postal_code_first', lang) }}</p>
      {% endif %}
    </div>
  </section>
  {% endif %}

  <section class="section">
    <h2 class="section-title">{{ t('coverage.current_cutoff', lang) }}</h2>
    <div class="form-card table-wrap">
      <table class="simple-table">
        <thead>
          <tr>
            <th>{{ t('coverage.location', lang) }}</th>
            <th>{{ t('coverage.delivery_active', lang) }}</th>
            <th>{{ t('coverage.cutoff_override', lang) }}</th>
            <th>{{ t('coverage.effective_cutoff', lang) }}</th>
            <th>{{ t('coverage.action', lang) }}</th>
          </tr>
        </thead>
        <tbody>
          {% for row in coverage_rows %}
          <tr>
            <td>{{ row.location.company_name }} — {{ row.location.address }} ({{ row.location.postal_code }}) {% if not row.location.is_active %}<span class="badge badge-muted">{{ t('menu.status_inactive', lang) }}</span>{% endif %}</td>
            <td>{{ t('coverage.yes', lang) if row.mapping_active else t('coverage.no', lang) }}</td>
            <td>{{ row.override_time.strftime('%H:%M') if row.override_time else '—' }}</td>
            <td>{{ row.effective_cutoff_time.strftime('%H:%M') if row.effective_cutoff_time else '—' }}</td>
            <td><a href="{{ '/restaurant/coverage' if current_user.role == 'restaurant' else '/admin/restaurant-coverage' }}?location_id={{ row.location.id }}{% if current_user.role == 'admin' %}&restaurant_id={{ selected_restaurant_id }}{% endif %}">{{ t('coverage.edit', lang) }}</a></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <section class="section">
    <h2 class="section-title">{{ t('coverage.update_cutoff', lang) }}</h2>
    <div class="form-card">
      <form method="post" action="{{ '/restaurant/coverage' if current_user.role == 'restaurant' else '/admin/restaurant-coverage' }}" class="stack-md">
        {% if current_user.role == "admin" %}<input type="hidden" name="restaurant_id" value="{{ selected_restaurant_id }}" />{% endif %}
        <label class="field"><span>{{ t('coverage.location', lang) }}</span>
          <select class="input" name="location_id" required>
            <option value="">{{ t('coverage.select_location', lang) }}</option>
            {% for location in locations %}
            <option value="{{ location.id }}" {% if selected_location_id == location.id %}selected{% endif %}>{{ location.company_name }} — {{ location.address }}</option>
            {% endfor %}
          </select>
        </label>
        <input type="hidden" name="mapping_active_present" value="1" />
        <label class="field-inline"><input type="checkbox" name="mapping_active" {% if selected_mapping_active %}checked{% endif %}/> {{ t('coverage.active_mapping', lang) }}</label>
        <label class="field"><span>{{ t('coverage.cutoff_override', lang) }}</span><input class="input" type="time" name="cut_off_override" value="{{ selected_override_time.strftime('%H:%M') if selected_override_time else '' }}" /></label>
        <p class="muted">{{ t('coverage.hint', lang) }}</p>
        <div class="actions-row"><button type="submit" name="action" value="save" class="btn btn--secondary">{{ t('coverage.save', lang) }}</button><button type="submit" name="action" value="clear_override" class="btn">{{ t('coverage.clear_override', lang) }}</button></div>
      </form>
    </div>
  </section>
</div>
{% endblock %}
