{% extends "base.html" %}

{% block title %}repo_new | {{ t('order.page_title', lang) }}{% endblock %}

{% block content %}
<header class="stack-md">
  <h1>{{ t('order.page_title', lang) }}</h1>
  <p class="lead">{{ t('order.page_lead', lang) }}</p>
</header>

{% if error %}
<p class="alert alert-error" role="alert">{{ error }}</p>
{% endif %}

{% if selected_restaurant and not ordering_open %}
<section class="card stack-md" aria-label="{{ t('order.opening_hours.title', lang) }}">
  <p class="alert alert-error" role="alert">Ta restauracja nie przyjmuje teraz zamówień (poza godzinami przyjmowania). Wybierz inną.</p>
  <p>{{ t('order.opening_hours.window', lang).format(open_time=ordering_open_time, close_time=ordering_close_time) }}</p>
  {% if next_opening_message %}
  <p>{{ next_opening_message }}</p>
  {% endif %}
</section>
{% endif %}

{% if cutoff_prompt %}
<section class="card stack-md" aria-label="Cut-off warning">
  <p class="alert alert-error" role="alert">{{ t('order.cutoff_prompt', lang) }}</p>
  <form method="post" action="/app/order" class="stack-md">
    <input type="hidden" name="location_id" value="{{ selected_location_id }}" />
    <input type="hidden" name="selected_date" value="{{ selected_date.isoformat() }}" />
    <input type="hidden" name="restaurant_id" value="{{ selected_restaurant_id }}" />
    {% for item in menu_items %}
    <input type="hidden" name="qty_{{ item.id }}" value="{{ quantities.get(item.id, 0) }}" />
    {% endfor %}
    <input type="hidden" name="order_for_next_day" value="1" />
    <div class="row-actions">
      <button type="submit" class="btn btn-primary">{{ t('order.next_day_confirm', lang) }}</button>
      <a href="/app" class="btn btn-secondary">{{ t('order.next_day_cancel', lang) }}</a>
    </div>
  </form>
</section>
{% endif %}

<section class="card stack-md" aria-label="{{ t('order.form_aria', lang) }}">
  <form method="get" action="/order" class="stack-md">
    <label class="field">
      <span>{{ t('order.select_location', lang) }}</span>
      <select name="location_id" required onchange="this.form.restaurant_id.value=''; this.form.submit()">
        <option value="">{{ t('order.select_location_placeholder', lang) }}</option>
        {% for location in locations %}
        <option value="{{ location.id }}" {% if selected_location_id == location.id %}selected{% endif %}>{{ location.company_name }} — {{ location.address }}</option>
        {% endfor %}
      </select>
    </label>
    <label class="field">
      <span>{{ t('menu.date', lang) }}</span>
      <input type="date" name="date" value="{{ selected_date.isoformat() }}" min="{{ min_date.isoformat() }}" max="{{ max_date.isoformat() }}" />
    </label>
    <label class="field">
      <span>Restaurant</span>
      {% if restaurants %}
      <select name="restaurant_id">
        <option value="">Select restaurant</option>
        {% for row in restaurants %}
        <option value="{{ row.restaurant.id }}" {% if selected_restaurant_id == row.restaurant.id %}selected{% endif %}>{{ row.restaurant.name }}</option>
        {% endfor %}
      </select>
      {% else %}
      <select name="restaurant_id" disabled>
        <option value="">Najpierw wybierz lokalizację</option>
      </select>
      {% endif %}
    </label>
    {% if selected_location_id %}
    <label>
      <input type="checkbox" name="show_open_only" value="1" {% if show_open_only %}checked{% endif %}>
      Wyświetlaj tylko otwarte
    </label>
    {% endif %}
    <button type="submit" class="btn btn-secondary">{{ t('menu.load_date', lang) }}</button>
  </form>

  {% if restaurants %}
  <div class="stack-sm">
    {% for row in restaurants %}
    <div>
      <a class="text-link" href="/order?location_id={{ selected_location_id }}&date={{ selected_date.isoformat() }}&restaurant_id={{ row.restaurant.id }}{% if show_open_only %}&show_open_only=1{% endif %}">{{ row.restaurant.name }}</a>
      <span class="badge {% if row.open_now %}badge-active{% else %}badge-inactive{% endif %}">{% if row.open_now %}OTWARTE{% else %}ZAMKNIĘTE{% endif %}</span>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  {% if selected_restaurant and menu_items %}
    {% if ordering_open %}
  <form method="post" action="/app/order" class="stack-md">
    <input type="hidden" name="selected_date" value="{{ selected_date.isoformat() }}" />
    <input type="hidden" name="restaurant_id" value="{{ selected_restaurant_id }}" />
    <label class="field">
      <span>{{ t('order.select_location', lang) }}</span>
      <select name="location_id" required>
        <option value="">{{ t('order.select_location_placeholder', lang) }}</option>
        {% for location in locations %}
        <option value="{{ location.id }}" {% if selected_location_id == location.id %}selected{% endif %}>{{ location.company_name }} — {{ location.address }}</option>
        {% endfor %}
      </select>
    </label>

    {% for item in menu_items %}
    <div>
      <strong>{{ item.name }}</strong>
      {% if item.description %}
      <p>{{ item.description }}</p>
      {% endif %}
      <p>{{ '%.2f'|format(item.price_cents / 100) }} PLN</p>
      <label class="field">
        <span>{{ t('dashboard.quantity', lang) }}</span>
        <input type="number" min="0" name="qty_{{ item.id }}" value="{{ quantities.get(item.id, 0) }}" />
      </label>
    </div>
    {% endfor %}
    <button type="submit" class="btn btn-primary">{{ t('dashboard.place_order', lang) }}</button>
  </form>
    {% else %}
  <p>{{ t('order.opening_hours.form_disabled', lang) }}</p>
    {% endif %}
  {% elif selected_restaurant %}
  <p>{{ t('order.empty_for_date', lang) }}</p>
  {% endif %}
</section>

<p class="top-gap-sm"><a class="text-link" href="/app">{{ t('nav.app', lang) }}</a></p>
{% endblock %}
