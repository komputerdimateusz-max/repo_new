const CART_KEY = 'cart_v1';

const state = {
  settings: null,
  companies: [],
  me: null,
  menu: { categories: [], active_category: null, items: [] },
  isClosed: false,
  cart: loadCart(),
};

function loadCart() {
  try {
    const parsed = JSON.parse(localStorage.getItem(CART_KEY) || '{}');
    return { items: parsed.items || {}, notes: parsed.notes || '', payment_method: parsed.payment_method || '' };
  } catch (_) {
    return { items: {}, notes: '', payment_method: '' };
  }
}
function saveCart(){localStorage.setItem(CART_KEY, JSON.stringify(state.cart));}
function clearCart(){localStorage.removeItem(CART_KEY);state.cart={items:{},notes:'',payment_method:''};}
function formatMoney(value){return `${Number(value).toFixed(2).replace('.', ',')} zł`;}
function isCartEmpty(){return Object.keys(state.cart.items).length===0;}
async function fetchJson(url, options = {}) { const response = await fetch(url, options); if (!response.ok) { const payload = await response.json().catch(() => ({})); throw { status: response.status, detail: payload.detail || 'Request failed.' }; } return response.json(); }
function computeClosed(settings){const now=new Date(settings.now_server);const [h,m]=settings.cut_off_time.split(':').map(Number);const cutoff=new Date(now);cutoff.setHours(h,m,0,0);return now>cutoff;}
function canOrder(){return !state.isClosed && !!state.me?.company_id;}
function menuCardTemplate(item){const inCartQty=state.cart.items[item.id]?.qty || 0; const disabled=canOrder()?'':'disabled'; return `<article class="menu-card" data-menu-card data-menu-item-id="${item.id}"><img class="menu-thumb" src="${item.image_url || '/static/placeholder_food.svg'}" alt="Zdjęcie dania ${item.name}" loading="lazy" /><div class="menu-card-content"><div class="menu-copy"><h3>${item.name}</h3><p>${item.description || ''}</p></div><div class="menu-meta">${item.badge ? `<span class="badge standard">${item.badge}</span>` : ''}<div class="price-row"><span class="price">${formatMoney(item.price)}</span><button type="button" class="add-btn" data-add-btn ${inCartQty > 0 ? 'hidden' : ''} ${disabled}>Dodaj</button><div class="qty-stepper" data-qty-control ${inCartQty === 0 ? 'hidden' : ''}><button type="button" data-action="decrease" ${disabled}>−</button><span data-qty>${inCartQty}</span><button type="button" data-action="increase" ${disabled}>+</button></div></div></div></div></article>`;}
function renderTabs(){const c=document.querySelector('[data-category-tabs]');c.innerHTML=state.menu.categories.map(category=>`<button class="tab ${category===state.menu.active_category?'active':''}" type="button" data-category="${category}">${category}</button>`).join('');c.querySelectorAll('[data-category]').forEach(tab=>tab.addEventListener('click',async()=>loadMenu(tab.dataset.category)));}
function renderMenu(){const grid=document.querySelector('[data-menu-grid]');grid.innerHTML=state.menu.items.map(menuCardTemplate).join('');grid.querySelectorAll('[data-menu-card]').forEach(card=>{const itemId=card.dataset.menuItemId;const addBtn=card.querySelector('[data-add-btn]');const qtyControl=card.querySelector('[data-qty-control]');const qtyEl=card.querySelector('[data-qty]');const menuItem=state.menu.items.find(x=>String(x.id)===itemId);if(!menuItem||!qtyEl)return;const setQty=(qty)=>{const next=Math.max(0,qty);if(next===0)delete state.cart.items[itemId];else state.cart.items[itemId]={qty:next,name:menuItem.name,price:Number(menuItem.price)};saveCart();renderMenu();renderCart();};addBtn?.addEventListener('click',()=>setQty(1));qtyControl?.addEventListener('click',(event)=>{const t=event.target;if(!(t instanceof HTMLButtonElement))return;const current=Number(qtyEl.textContent)||0;if(t.dataset.action==='increase')setQty(current+1);if(t.dataset.action==='decrease')setQty(current-1);});});}
function renderCart(){const list=document.querySelector('[data-cart-list]');const subtotal=Object.values(state.cart.items).reduce((s,i)=>s+i.qty*i.price,0);list.innerHTML=Object.values(state.cart.items).map(item=>`<li><div><strong>${item.name}</strong><small>${item.qty} × ${formatMoney(item.price)}</small></div></li>`).join('');document.querySelector('[data-summary-subtotal]').textContent=formatMoney(subtotal);const df=Number(state.settings?.delivery_fee||0);document.querySelector('[data-summary-delivery]').textContent=formatMoney(df);document.querySelector('[data-summary-window]').textContent=`${state.settings?.delivery_window_start || '--:--'}–${state.settings?.delivery_window_end || '--:--'}`;document.querySelector('[data-summary-total]').textContent=formatMoney(subtotal+df);document.querySelector('[data-checkout-btn]').disabled=isCartEmpty()||!canOrder();document.querySelector('[data-company-required-banner]').hidden=!!state.me?.company_id;}
async function persistMeCompany(){if(!state.me)return;const select=document.querySelector('[data-company-select]');state.me.company_id=select.value?Number(select.value):null;await fetchJson('/api/v1/me',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:state.me.name,postal_code:state.me.postal_code,company_id:state.me.company_id})});renderMenu();renderCart();}
function renderCompanies(){const select=document.querySelector('[data-company-select]');select.innerHTML='<option value="">Wybierz firmę</option>'+state.companies.map(company=>`<option value="${company.id}">${company.name}</option>`).join('');if(state.me?.company_id)select.value=String(state.me.company_id);select.addEventListener('change',()=>persistMeCompany().catch(()=>setMessage('Nie udało się zapisać firmy.', true)));}
function renderSettings(){document.querySelector('[data-cutoff-time]').textContent=state.settings.cut_off_time;document.querySelector('[data-cutoff-banner]').hidden=!state.isClosed;}
function wireSidebarInputs(){const notes=document.querySelector('[data-cart-notes]');notes.value=state.cart.notes;notes.addEventListener('input',()=>{state.cart.notes=notes.value;saveCart();});document.querySelectorAll('[data-payment-method]').forEach((btn)=>{btn.classList.toggle('blik',btn.dataset.paymentMethod===state.cart.payment_method);btn.addEventListener('click',()=>{state.cart.payment_method=btn.dataset.paymentMethod;saveCart();document.querySelectorAll('[data-payment-method]').forEach((innerBtn)=>innerBtn.classList.toggle('blik',innerBtn.dataset.paymentMethod===state.cart.payment_method));});});}
function setMessage(text,isError=false){const el=document.querySelector('[data-inline-message]');el.hidden=!text;el.textContent=text;el.style.color=isError?'#b42318':'#0f5132';}
function renderConfirmation(response){const el=document.querySelector('[data-order-confirmation]');el.innerHTML=`<div style="border:1px solid #cce0ff;padding:10px;border-radius:8px;margin:8px 0;"><h3>Zamówienie potwierdzone #${response.order_id}</h3><p>Suma: ${formatMoney(response.subtotal_amount)} + dostawa ${formatMoney(response.delivery_fee)} = <strong>${formatMoney(response.total_amount)}</strong></p><p>Okno dostawy: ${response.delivery_window_start}–${response.delivery_window_end}</p><p>Płatność: ${response.payment_method}</p><ul>${response.items.map(i=>`<li>${i.menu_item_id} x ${i.qty}</li>`).join('')}</ul></div>`;}
async function submitOrder(){const payload={notes:state.cart.notes,payment_method:state.cart.payment_method,items:Object.entries(state.cart.items).map(([menu_item_id,item])=>({menu_item_id:Number(menu_item_id),qty:item.qty}))};if(!state.me?.company_id||!payload.payment_method||payload.items.length===0){setMessage('Wybierz firmę w profilu, płatność i co najmniej jedną pozycję.',true);return;}try{const response=await fetchJson('/api/v1/orders',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});renderConfirmation(response);setMessage('Zamówienie przyjęte.');clearCart();document.querySelector('[data-cart-notes]').value='';renderMenu();renderCart();wireSidebarInputs();}catch(error){if(error.status===403){state.isClosed=true;renderSettings();renderMenu();renderCart();setMessage('Zamówienia na dziś są zamknięte.',true);return;}setMessage(error.detail||'Nie udało się złożyć zamówienia.',true);}}
async function loadMenu(category=''){const suffix=category?`?category=${encodeURIComponent(category)}`:'';state.menu=await fetchJson(`/api/v1/menu/today${suffix}`);if(!state.menu.active_category&&state.menu.categories.length>0){state.menu.active_category=state.menu.categories[0];}renderTabs();renderMenu();}
async function init(){state.settings=await fetchJson('/api/v1/settings');state.companies=await fetchJson('/api/v1/companies');state.me=await fetchJson('/api/v1/me');state.isClosed=computeClosed(state.settings);renderSettings();renderCompanies();wireSidebarInputs();await loadMenu();renderCart();document.querySelector('[data-checkout-btn]').addEventListener('click',submitOrder);}
init().catch(()=>setMessage('Nie udało się załadować danych.',true));
